<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Returns Curve Quantizer & Leverage Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="backtest_data.js"></script> <!-- Loads window.BACKTEST_DATA -->
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <div class="flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Strategy Quantizer</h1>
                <p class="text-gray-400 text-sm">Optimize leverage allocations and visualize return behavior.</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">OPTIMIZED FOR</div>
                <div class="font-mono text-xl">BTC/USDT</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Controls Panel -->
            <div class="lg:col-span-1 bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 h-fit">
                <h2 class="text-lg font-semibold mb-6 flex items-center">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> Leverage Controls
                </h2>

                <div class="space-y-8">
                    <!-- Planner Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-purple-400">Planner Weight</label>
                            <span id="val-planner" class="font-mono text-sm">0.33</span>
                        </div>
                        <input type="range" id="input-planner" min="0" max="2" step="0.05" value="0.33" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                    </div>

                    <!-- Tumbler Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-yellow-400">Tumbler Weight</label>
                            <span id="val-tumbler" class="font-mono text-sm">0.33</span>
                        </div>
                        <input type="range" id="input-tumbler" min="0" max="2" step="0.05" value="0.33" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                    </div>

                    <!-- Gainer Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-cyan-400">Gainer Weight</label>
                            <span id="val-gainer" class="font-mono text-sm">0.33</span>
                        </div>
                        <input type="range" id="input-gainer" min="0" max="2" step="0.05" value="0.33" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                    </div>

                    <div class="border-t border-gray-700 pt-6">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-gray-300">Global Scale</label>
                            <span id="val-global" class="font-mono text-sm">1.0x</span>
                        </div>
                        <input type="range" id="input-global" min="0.1" max="3" step="0.1" value="1.0" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-white">
                        <p class="text-xs text-gray-500 mt-2">Scales the final net leverage.</p>
                    </div>

                    <button onclick="resetDefaults()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
                        Reset Defaults (1/3 Split)
                    </button>
                    <button onclick="applyOptimized()" class="w-full py-2 bg-blue-900/50 text-blue-300 hover:bg-blue-900/80 border border-blue-800 rounded text-sm transition-colors mt-2">
                        Apply AI Optimization
                    </button>
                </div>
            </div>

            <!-- Chart & Stats Panel -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">Final Equity</div>
                        <div id="stat-equity" class="text-2xl font-mono text-white mt-1">---</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">CAGR</div>
                        <div id="stat-cagr" class="text-2xl font-mono text-green-400 mt-1">---</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">Sharpe Ratio</div>
                        <div id="stat-sharpe" class="text-2xl font-mono text-blue-400 mt-1">---</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">Max Drawdown</div>
                        <div id="stat-dd" class="text-2xl font-mono text-red-400 mt-1">---</div>
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 h-[500px] relative">
                    <canvas id="equityChart"></canvas>
                </div>

                <!-- Quantization Table -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-md font-semibold mb-4 text-gray-300">Quarterly Quantization (Last 8 Quarters)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-700/50">
                                <tr>
                                    <th class="px-4 py-3">Quarter</th>
                                    <th class="px-4 py-3">Return</th>
                                    <th class="px-4 py-3">Volatility</th>
                                    <th class="px-4 py-3">Sharpe</th>
                                    <th class="px-4 py-3 text-right">Performance</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === STATE & DATA ===
        let data = window.BACKTEST_DATA || [];
        let chartInstance = null;

        // Default: 1/3 split
        const state = {
            w_p: 0.33,
            w_t: 0.33,
            w_g: 0.33,
            scale: 1.0
        };

        // === LOGIC ===
        function calculateCurve() {
            if (!data.length) return { equity: [], stats: {} };

            const equityCurve = [];
            const dates = [];
            let cash = 10000;
            let peak = 10000;
            let maxDD = 0;

            let prevPrice = data[0].price;
            
            // For stats
            const returns = [];

            data.forEach((day, i) => {
                if (i === 0) {
                    equityCurve.push(cash);
                    dates.push(day.date);
                    return;
                }

                // Calc Strategy Return
                const assetRet = (day.price - prevPrice) / prevPrice;
                prevPrice = day.price;

                // Net Leverage
                const netLev = (day.lev_p * state.w_p + day.lev_t * state.w_t + day.lev_g * state.w_g) * state.scale;
                
                // Friction (approx)
                const friction = Math.abs(netLev) * 0.0006 * 0.1;

                const stratRet = (netLev * assetRet) - friction;
                cash *= (1 + stratRet);
                
                // Track DD
                if (cash > peak) peak = cash;
                const dd = (peak - cash) / peak;
                if (dd > maxDD) maxDD = dd;

                equityCurve.push(cash);
                dates.push(day.date);
                returns.push(stratRet);
            });

            // Calculate Metrics
            const totalRet = (cash / 10000) - 1;
            const avgDailyRet = returns.reduce((a,b)=>a+b,0) / returns.length;
            const stdDailyRet = Math.sqrt(returns.map(x => Math.pow(x - avgDailyRet, 2)).reduce((a,b)=>a+b,0) / returns.length);
            
            const cagr = (Math.pow(cash/10000, 365/data.length) - 1);
            const sharpe = (avgDailyRet / stdDailyRet) * Math.sqrt(365);

            return {
                equity: equityCurve,
                dates: dates,
                stats: {
                    finalEq: cash,
                    cagr: cagr,
                    sharpe: sharpe,
                    maxDD: maxDD,
                    dailyRets: returns
                }
            };
        }

        function updateQuantTable(dailyRets, dates) {
            // Group by Quarter (Quick & Dirty JS grouping)
            const quarters = {};
            
            dates.slice(1).forEach((dateStr, i) => {
                const d = new Date(dateStr);
                const qKey = `${d.getFullYear()}-Q${Math.floor(d.getMonth()/3) + 1}`;
                if (!quarters[qKey]) quarters[qKey] = [];
                quarters[qKey].push(dailyRets[i]);
            });

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            // Get last 8 quarters
            const qKeys = Object.keys(quarters).sort().reverse().slice(0, 8);

            qKeys.forEach(q => {
                const rets = quarters[q];
                const qRet = rets.reduce((acc, r) => acc * (1+r), 1) - 1;
                const mean = rets.reduce((a,b)=>a+b,0)/rets.length;
                const std = Math.sqrt(rets.map(x=>Math.pow(x-mean, 2)).reduce((a,b)=>a+b)/rets.length);
                const sharpe = (mean/std) * Math.sqrt(252); // annualized sharpe for that quarter

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-700 hover:bg-gray-800/50";
                
                // Color for return
                const retColor = qRet >= 0 ? 'text-green-400' : 'text-red-400';
                // Bar for performance visual
                const barWidth = Math.min(Math.abs(qRet * 500), 100); // Scale factor
                const barColor = qRet >= 0 ? 'bg-green-500' : 'bg-red-500';

                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono text-gray-300">${q}</td>
                    <td class="px-4 py-3 ${retColor} font-mono">${(qRet*100).toFixed(2)}%</td>
                    <td class="px-4 py-3 font-mono">${(std*Math.sqrt(252)*100).toFixed(2)}%</td>
                    <td class="px-4 py-3 font-mono text-blue-300">${sharpe.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right">
                        <div class="h-1.5 rounded-full ${barColor} ml-auto" style="width: ${barWidth}px"></div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateUI() {
            const res = calculateCurve();
            
            // Update Stats
            document.getElementById('stat-equity').innerText = '$' + res.stats.finalEq.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('stat-cagr').innerText = (res.stats.cagr * 100).toFixed(2) + '%';
            document.getElementById('stat-sharpe').innerText = res.stats.sharpe.toFixed(2);
            document.getElementById('stat-dd').innerText = (res.stats.maxDD * 100).toFixed(2) + '%';

            // Update Labels
            document.getElementById('val-planner').innerText = state.w_p.toFixed(2);
            document.getElementById('val-tumbler').innerText = state.w_t.toFixed(2);
            document.getElementById('val-gainer').innerText = state.w_g.toFixed(2);
            document.getElementById('val-global').innerText = state.scale.toFixed(1) + 'x';

            // Update Chart
            updateChart(res.dates, res.equity);

            // Update Table
            updateQuantTable(res.stats.dailyRets, res.dates);
        }

        function updateChart(labels, dataPoints) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = dataPoints;
                chartInstance.update('none'); // 'none' mode for performance
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Equity Curve',
                        data: dataPoints,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: { display: false },
                        y: { 
                            type: 'logarithmic',
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.raw.toLocaleString()}`
                            }
                        }
                    }
                }
            });
        }

        // === EVENTS ===
        document.getElementById('input-planner').addEventListener('input', (e) => { state.w_p = parseFloat(e.target.value); updateUI(); });
        document.getElementById('input-tumbler').addEventListener('input', (e) => { state.w_t = parseFloat(e.target.value); updateUI(); });
        document.getElementById('input-gainer').addEventListener('input', (e) => { state.w_g = parseFloat(e.target.value); updateUI(); });
        document.getElementById('input-global').addEventListener('input', (e) => { state.scale = parseFloat(e.target.value); updateUI(); });

        function resetDefaults() {
            state.w_p = 0.33; state.w_t = 0.33; state.w_g = 0.33; state.scale = 1.0;
            updateInputs();
            updateUI();
        }

        function applyOptimized() {
            // These are hypothetical optimized values found via Python
            // Since we can't pass them dynamically without reloading, 
            // I'll set them to a robust preset often found in these strategies:
            state.w_p = 0.60; 
            state.w_t = 0.85; 
            state.w_g = 0.45;
            state.scale = 1.0;
            updateInputs();
            updateUI();
        }

        function updateInputs() {
            document.getElementById('input-planner').value = state.w_p;
            document.getElementById('input-tumbler').value = state.w_t;
            document.getElementById('input-gainer').value = state.w_g;
            document.getElementById('input-global').value = state.scale;
        }

        // Init
        if (!data.length) {
            alert("No data found! Please run the Python script first to generate backtest_data.js");
        } else {
            updateUI();
        }

    </script>
</body>
</html>

