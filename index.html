<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Returns Curve - Capital Allocation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="backtest_data.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <div class="flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-400">Capital Allocation Playground</h1>
                <p class="text-gray-400 text-sm">Adjust the capital available to each strategy logic.</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">LIVE DEMO</div>
                <div class="font-mono text-xl">BTC/USDT</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Controls Panel -->
            <div class="lg:col-span-1 bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 h-fit">
                
                <!-- Presets -->
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <button onclick="setAll(0.33)" class="py-2 px-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-mono transition-colors">1/3 (Default)</button>
                    <button onclick="setAll(0.66)" class="py-2 px-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-mono transition-colors">2/3 (Heavy)</button>
                    <button onclick="setAll(1.00)" class="py-2 px-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-mono transition-colors">3/3 (Full)</button>
                    <button onclick="setAll(1.33)" class="py-2 px-1 bg-purple-900/50 hover:bg-purple-900/80 border border-purple-800 rounded text-xs font-mono transition-colors text-purple-200">4/3 (Overdrive)</button>
                </div>

                <div class="space-y-6">
                    <!-- Planner Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-purple-400">Planner Capital</label>
                            <span id="val-planner" class="font-mono text-sm">33%</span>
                        </div>
                        <input type="range" id="input-planner" min="0" max="1.5" step="0.01" value="0.33" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                    </div>

                    <!-- Tumbler Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-yellow-400">Tumbler Capital</label>
                            <span id="val-tumbler" class="font-mono text-sm">33%</span>
                        </div>
                        <input type="range" id="input-tumbler" min="0" max="1.5" step="0.01" value="0.33" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                    </div>

                    <!-- Gainer Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-cyan-400">Gainer Capital</label>
                            <span id="val-gainer" class="font-mono text-sm">33%</span>
                        </div>
                        <input type="range" id="input-gainer" min="0" max="1.5" step="0.01" value="0.33" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-gray-700">
                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                        <span>Total Allocation:</span>
                        <span id="total-alloc" class="font-mono text-white">100%</span>
                    </div>
                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                        <div id="bar-total" class="bg-blue-500 h-full transition-all duration-300" style="width: 33%"></div>
                    </div>
                </div>
            </div>

            <!-- Chart & Stats Panel -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">Final Equity</div>
                        <div id="stat-equity" class="text-2xl font-mono text-white mt-1">---</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">CAGR</div>
                        <div id="stat-cagr" class="text-2xl font-mono text-green-400 mt-1">---</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">Sharpe Ratio</div>
                        <div id="stat-sharpe" class="text-2xl font-mono text-blue-400 mt-1">---</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs uppercase tracking-wider">Max Drawdown</div>
                        <div id="stat-dd" class="text-2xl font-mono text-red-400 mt-1">---</div>
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 h-[500px] relative">
                    <canvas id="equityChart"></canvas>
                </div>

                <!-- Quantization Table -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-md font-semibold mb-4 text-gray-300">Quarterly Quantization</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-700/50">
                                <tr>
                                    <th class="px-4 py-3">Quarter</th>
                                    <th class="px-4 py-3">Return</th>
                                    <th class="px-4 py-3">Volatility</th>
                                    <th class="px-4 py-3">Sharpe</th>
                                    <th class="px-4 py-3 text-right">Performance</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = window.BACKTEST_DATA || [];
        let chartInstance = null;
        const state = { w_p: 0.33, w_t: 0.33, w_g: 0.33 };

        function calculateCurve() {
            if (!data.length) return { equity: [], stats: {} };

            const equityCurve = [];
            const dates = [];
            let cash = 10000;
            let peak = 10000;
            let maxDD = 0;
            let prevPrice = data[0].price;
            const returns = [];

            data.forEach((day, i) => {
                if (i === 0) {
                    equityCurve.push(cash);
                    dates.push(day.date);
                    return;
                }

                const assetRet = (day.price - prevPrice) / prevPrice;
                prevPrice = day.price;

                // Net Leverage = Sum of (Signal * Capital Allocation)
                const netLev = (day.lev_p * state.w_p) + (day.lev_t * state.w_t) + (day.lev_g * state.w_g);
                
                // Friction
                const friction = Math.abs(netLev) * 0.0006 * 0.1; 
                const stratRet = (netLev * assetRet) - friction;
                
                cash *= (1 + stratRet);
                if (cash > peak) peak = cash;
                const dd = (peak - cash) / peak;
                if (dd > maxDD) maxDD = dd;

                equityCurve.push(cash);
                dates.push(day.date);
                returns.push(stratRet);
            });

            const totalRet = (cash / 10000) - 1;
            const avgDailyRet = returns.reduce((a,b)=>a+b,0) / returns.length;
            const stdDailyRet = Math.sqrt(returns.map(x => Math.pow(x - avgDailyRet, 2)).reduce((a,b)=>a+b,0) / returns.length);
            const sharpe = stdDailyRet > 0 ? (avgDailyRet / stdDailyRet) * Math.sqrt(365) : 0;
            const cagr = Math.pow(cash/10000, 365/data.length) - 1;

            return {
                equity: equityCurve,
                dates: dates,
                stats: { finalEq: cash, cagr: cagr, sharpe: sharpe, maxDD: maxDD, dailyRets: returns }
            };
        }

        function updateQuantTable(dailyRets, dates) {
            const quarters = {};
            dates.slice(1).forEach((dateStr, i) => {
                const d = new Date(dateStr);
                const qKey = `${d.getFullYear()}-Q${Math.floor(d.getMonth()/3) + 1}`;
                if (!quarters[qKey]) quarters[qKey] = [];
                quarters[qKey].push(dailyRets[i]);
            });

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            const qKeys = Object.keys(quarters).sort().reverse().slice(0, 8);

            qKeys.forEach(q => {
                const rets = quarters[q];
                const qRet = rets.reduce((acc, r) => acc * (1+r), 1) - 1;
                const mean = rets.reduce((a,b)=>a+b,0)/rets.length;
                const std = Math.sqrt(rets.map(x=>Math.pow(x-mean, 2)).reduce((a,b)=>a+b)/rets.length);
                const sharpe = std > 0 ? (mean/std) * Math.sqrt(252) : 0;
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-700 hover:bg-gray-800/50";
                const retColor = qRet >= 0 ? 'text-green-400' : 'text-red-400';
                const barWidth = Math.min(Math.abs(qRet * 500), 100);
                const barColor = qRet >= 0 ? 'bg-green-500' : 'bg-red-500';

                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono text-gray-300">${q}</td>
                    <td class="px-4 py-3 ${retColor} font-mono">${(qRet*100).toFixed(2)}%</td>
                    <td class="px-4 py-3 font-mono">${(std*Math.sqrt(252)*100).toFixed(2)}%</td>
                    <td class="px-4 py-3 font-mono text-blue-300">${sharpe.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right"><div class="h-1.5 rounded-full ${barColor} ml-auto" style="width: ${barWidth}px"></div></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateChart(labels, dataPoints) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = dataPoints;
                chartInstance.update('none');
                return;
            }
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Equity Curve', data: dataPoints,
                        borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        borderWidth: 2, pointRadius: 0, fill: true, tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: { display: false },
                        y: { type: 'logarithmic', grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function setAll(val) {
            state.w_p = val; state.w_t = val; state.w_g = val;
            updateInputs();
            updateUI();
        }

        function updateInputs() {
            document.getElementById('input-planner').value = state.w_p;
            document.getElementById('input-tumbler').value = state.w_t;
            document.getElementById('input-gainer').value = state.w_g;
        }

        function updateUI() {
            const res = calculateCurve();
            
            // Labels
            document.getElementById('val-planner').innerText = (state.w_p * 100).toFixed(0) + '%';
            document.getElementById('val-tumbler').innerText = (state.w_t * 100).toFixed(0) + '%';
            document.getElementById('val-gainer').innerText = (state.w_g * 100).toFixed(0) + '%';
            
            // Total Bar
            const total = state.w_p + state.w_t + state.w_g;
            document.getElementById('total-alloc').innerText = (total * 100).toFixed(0) + '%';
            const barW = Math.min(total / 3 * 100, 100);
            document.getElementById('bar-total').style.width = barW + '%';
            document.getElementById('bar-total').className = `h-full transition-all duration-300 ${total > 1.5 ? 'bg-purple-500' : 'bg-blue-500'}`;

            // Stats
            document.getElementById('stat-equity').innerText = '$' + res.stats.finalEq.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('stat-cagr').innerText = (res.stats.cagr * 100).toFixed(2) + '%';
            document.getElementById('stat-sharpe').innerText = res.stats.sharpe.toFixed(2);
            document.getElementById('stat-dd').innerText = (res.stats.maxDD * 100).toFixed(2) + '%';

            updateChart(res.dates, res.equity);
            updateQuantTable(res.stats.dailyRets, res.dates);
        }

        document.getElementById('input-planner').addEventListener('input', (e) => { state.w_p = parseFloat(e.target.value); updateUI(); });
        document.getElementById('input-tumbler').addEventListener('input', (e) => { state.w_t = parseFloat(e.target.value); updateUI(); });
        document.getElementById('input-gainer').addEventListener('input', (e) => { state.w_g = parseFloat(e.target.value); updateUI(); });

        if (!data.length) setTimeout(() => window.location.reload(), 3000);
        else updateUI();
    </script>
</body>
</html>
